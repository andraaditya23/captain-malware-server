import smtplib
from email.mime.multipart import MIMEMultipart
from email.message import EmailMessage
from email.mime.text import MIMEText
import logging
from threading import Timer
import yaml

def read_yaml_file(file_path):
    try:
        with open(file_path, 'r') as yaml_file:
            data = yaml.safe_load(yaml_file)
            return data
    except FileNotFoundError:
        return {}
    
def send_email(admin_data):
    log_format = '%(asctime)s - %(message)s'
    logging.basicConfig(level=logging.INFO, format=log_format, datefmt='%Y-%m-%d %H:%M:%S')
    handler = logging.FileHandler('LogYara.txt')
    handler.setFormatter(logging.Formatter(log_format))
    logging.getLogger().addHandler(handler)
    from_addr = "adm.captainmalware@gmail.com"
    password = "jutzyuenyisodbkn"

    subject = "ALERT: Malware detected!"

    for admin_email, entries in admin_data.items():
        msg = MIMEMultipart()
        msg['From'] = from_addr
        msg['To'] = admin_email
        msg['Subject'] = subject

        html_body = f"""
        <html>
        <head>
            <style>
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f2f2f2;
                margin: 0;
                padding: 0;
            }}
            h1 {{
                color: #333;
                text-align: center;
            }}
            .container {{
                max-width: 600px;
                margin: 20px auto;
                background-color: #fff;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                border: 3px solid #000; /* Add a solid black outline */
            }}
            .header {{
                background-color: #333;
                color: #fff;
                padding: 20px;
                border-radius: 10px 10px 0 0;
            }}
            .content {{
                padding: 20px;
            }}
            p {{
                color: #555;
            }}
            .action-button {{
                display: inline-block;
                background-color: #08ff3d;
                color: #fff;
                padding: 10px 20px;
                text-decoration: none;
                border-radius: 5px;
                border: 2px solid #000; /* Add a solid black outline */
                transition: background-color 0.3s ease; /* Add transition effect */
            }}

            .action-button:hover {{
                background-color: #ff787d;
            }}

            .action-button span {{
                display: inline-block;
                font-weight: bold;
                border-radius: 5px;
                border: 1px solid #000; /* Add a solid black outline */
            }}
            </style>
        </head>
        <body>
            <div class="container">
            <div class="header">
                <h1 style="color: #fff;">Malware Detection Report</h1>
            </div>
            <div class="content">
        """

        for entry in entries:
            email_body = {
                'timestamp': entry['timestamp'],
                'filepath': entry['filepath'],
                'malware_type': entry['malware_type'],
            }

            html_body += f"""
                <p><strong>Timestamp:</strong> {email_body['timestamp']}</p>
                <p><strong>Malware Detected in File:</strong> {email_body['filepath']}</p>
                <p><strong>Detected Type:</strong> {email_body['malware_type']}</p>
                <p><strong>Action: Quarantine File</strong></p>
                <p>
                Incase of False Positive, To take action and retrieve the file, click the button below:
                <br>
                <a href="https://captainmalware.pharmalink.id/retrievefile" class="action-button">
                    <span>Retrieve File</span>
                </a>
                </p>
            """

        html_body += """
            </div>
            </div>
        </body>
        </html>
        """

        msg.attach(MIMEText(html_body, 'html'))

        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(from_addr, password)
        server.send_message(msg)
        server.quit()